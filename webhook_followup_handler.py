# -*- coding: utf-8 -*-
"""
Updated webhook.py - Add GetFollowUpSummary Intent Handler
‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏õ‡∏±‡∏ç‡∏´‡∏≤ Rich Menu ‡∏ó‡∏µ‡πà trigger ‡∏ú‡∏¥‡∏î Intent
"""

# ‡πÄ‡∏û‡∏¥‡πà‡∏° code ‡∏ô‡∏µ‡πâ‡πÉ‡∏ô routes/webhook.py

# ========================================
# Part 1: ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÉ‡∏ô Intent Routing
# ========================================
# ‡∏´‡∏≤‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡∏ó‡∏µ‡πà‡∏°‡∏µ:
#     elif intent == 'GetKnowledge':
#         return handle_get_knowledge(params)
#
# ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏´‡∏•‡∏±‡∏á‡∏à‡∏≤‡∏Å‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡∏ô‡∏±‡πâ‡∏ô:

elif intent == 'GetFollowUpSummary':
    return handle_get_followup_summary(user_id)


# ========================================
# Part 2: ‡πÄ‡∏û‡∏¥‡πà‡∏° Handler Function
# ========================================
# ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Å‡πà‡∏≠‡∏ô function handle_unknown_intent(intent):

def handle_get_followup_summary(user_id):
    """
    Handle GetFollowUpSummary intent
    ‡πÅ‡∏™‡∏î‡∏á‡∏™‡∏£‡∏∏‡∏õ‡∏Å‡∏≤‡∏£‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢‡∏´‡∏•‡∏±‡∏á‡∏à‡∏≥‡∏´‡∏ô‡πà‡∏≤‡∏¢
    
    Args:
        user_id: User's LINE ID
        
    Returns:
        JSON response with follow-up summary
    """
    try:
        from services.reminder import get_reminder_summary
        
        logger.info(f"GetFollowUpSummary request from {user_id}")
        
        # Get reminder summary from database
        summary = get_reminder_summary(user_id)
        
        # Check if user has any reminders
        if summary['total_reminders'] == 0:
            message = (
                "üìã ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°‡∏Ñ‡πà‡∏∞\n\n"
                "‡∏´‡∏•‡∏±‡∏á‡∏à‡∏≤‡∏Å‡∏ó‡∏µ‡πà‡∏Ñ‡∏∏‡∏ì‡∏à‡∏≥‡∏´‡∏ô‡πà‡∏≤‡∏¢‡∏à‡∏≤‡∏Å‡πÇ‡∏£‡∏á‡∏û‡∏¢‡∏≤‡∏ö‡∏≤‡∏•\n"
                "‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°‡∏≠‡∏≤‡∏Å‡∏≤‡∏£‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥\n\n"
                "üí° ‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞‡∏™‡πà‡∏á‡∏Å‡∏≤‡∏£‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡πÉ‡∏ô‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà:\n"
                "   ‚Ä¢ ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà 3 ‡∏´‡∏•‡∏±‡∏á‡∏à‡∏≥‡∏´‡∏ô‡πà‡∏≤‡∏¢\n"
                "   ‚Ä¢ ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà 7 (‡∏™‡∏±‡∏õ‡∏î‡∏≤‡∏´‡πå‡πÅ‡∏£‡∏Å)\n"
                "   ‚Ä¢ ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà 14 (‡∏™‡∏±‡∏õ‡∏î‡∏≤‡∏´‡πå‡∏ó‡∏µ‡πà 2)\n"
                "   ‚Ä¢ ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà 30 (‡∏Ñ‡∏£‡∏ö 1 ‡πÄ‡∏î‡∏∑‡∏≠‡∏ô)"
            )
        else:
            # Build summary message
            message = (
                f"üìä ‡∏™‡∏£‡∏∏‡∏õ‡∏Å‡∏≤‡∏£‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì\n"
                f"{'=' * 30}\n\n"
                f"üìå ‡∏£‡∏ß‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î: {summary['total_reminders']} ‡∏Ñ‡∏£‡∏±‡πâ‡∏á\n"
                f"‚úÖ ‡∏ï‡∏≠‡∏ö‡∏Å‡∏•‡∏±‡∏ö‡πÅ‡∏•‡πâ‡∏ß: {summary['responded']} ‡∏Ñ‡∏£‡∏±‡πâ‡∏á\n"
                f"‚è≥ ‡∏£‡∏≠‡∏ï‡∏≠‡∏ö‡∏Å‡∏•‡∏±‡∏ö: {summary['pending']} ‡∏Ñ‡∏£‡∏±‡πâ‡∏á\n"
            )
            
            if summary['no_response'] > 0:
                message += f"‚ö†Ô∏è ‡πÑ‡∏°‡πà‡∏ï‡∏≠‡∏ö‡∏Å‡∏•‡∏±‡∏ö: {summary['no_response']} ‡∏Ñ‡∏£‡∏±‡πâ‡∏á\n"
            
            message += "\n"
            
            # Add latest reminder info
            if summary.get('latest'):
                latest = summary['latest']
                reminder_type = latest.get('Reminder_Type', 'unknown')
                status = latest.get('Status', 'unknown')
                timestamp = latest.get('Timestamp', '')
                
                # Format reminder type
                type_map = {
                    'day3': '‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà 3',
                    'day7': '‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà 7',
                    'day14': '‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà 14',
                    'day30': '‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà 30'
                }
                type_display = type_map.get(reminder_type, reminder_type)
                
                # Format status
                status_map = {
                    'sent': '‚è≥ ‡∏£‡∏≠‡∏ï‡∏≠‡∏ö‡∏Å‡∏•‡∏±‡∏ö',
                    'responded': '‚úÖ ‡∏ï‡∏≠‡∏ö‡∏Å‡∏•‡∏±‡∏ö‡πÅ‡∏•‡πâ‡∏ß',
                    'no_response': '‚ö†Ô∏è ‡πÑ‡∏°‡πà‡∏ï‡∏≠‡∏ö‡∏Å‡∏•‡∏±‡∏ö'
                }
                status_display = status_map.get(status, status)
                
                message += (
                    f"üîî ‡∏Å‡∏≤‡∏£‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î:\n"
                    f"   üìÖ {type_display}\n"
                    f"   ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞: {status_display}\n"
                )
                
                if timestamp:
                    message += f"   ‚è∞ {timestamp}\n"
            
            message += (
                f"\n"
                f"üí° ‡∏û‡∏¢‡∏≤‡∏ö‡∏≤‡∏•‡∏à‡∏∞‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°‡∏≠‡∏≤‡∏Å‡∏≤‡∏£‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì\n"
                f"‡πÄ‡∏õ‡πá‡∏ô‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏ï‡∏≤‡∏°‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏Å‡∏≤‡∏£‡∏ô‡∏∞‡∏Ñ‡∏∞"
            )
        
        return jsonify({"fulfillmentText": message}), 200
        
    except Exception as e:
        logger.exception(f"Error in GetFollowUpSummary: {e}")
        return jsonify({
            "fulfillmentText": (
                "‡∏Ç‡∏≠‡πÇ‡∏ó‡∏©‡∏Ñ‡πà‡∏∞ ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•\n"
                "‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏´‡∏£‡∏∑‡∏≠‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠‡∏û‡∏¢‡∏≤‡∏ö‡∏≤‡∏•‡∏Ñ‡πà‡∏∞"
            )
        }), 200


# ========================================
# Part 3: ‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô
# ========================================
"""
‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á Response:

Input (‡∏à‡∏≤‡∏Å LINE): "‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°‡∏´‡∏•‡∏±‡∏á‡∏à‡∏≥‡∏´‡∏ô‡πà‡∏≤‡∏¢"
Dialogflow Intent: GetFollowUpSummary
Output:

üìä ‡∏™‡∏£‡∏∏‡∏õ‡∏Å‡∏≤‡∏£‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì
==============================

üìå ‡∏£‡∏ß‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î: 2 ‡∏Ñ‡∏£‡∏±‡πâ‡∏á
‚úÖ ‡∏ï‡∏≠‡∏ö‡∏Å‡∏•‡∏±‡∏ö‡πÅ‡∏•‡πâ‡∏ß: 1 ‡∏Ñ‡∏£‡∏±‡πâ‡∏á
‚è≥ ‡∏£‡∏≠‡∏ï‡∏≠‡∏ö‡∏Å‡∏•‡∏±‡∏ö: 1 ‡∏Ñ‡∏£‡∏±‡πâ‡∏á

üîî ‡∏Å‡∏≤‡∏£‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î:
   üìÖ ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà 7
   ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞: ‚è≥ ‡∏£‡∏≠‡∏ï‡∏≠‡∏ö‡∏Å‡∏•‡∏±‡∏ö
   ‚è∞ 2026-01-06 09:00:00

üí° ‡∏û‡∏¢‡∏≤‡∏ö‡∏≤‡∏•‡∏à‡∏∞‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°‡∏≠‡∏≤‡∏Å‡∏≤‡∏£‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì
‡πÄ‡∏õ‡πá‡∏ô‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏ï‡∏≤‡∏°‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏Å‡∏≤‡∏£‡∏ô‡∏∞‡∏Ñ‡∏∞
"""
